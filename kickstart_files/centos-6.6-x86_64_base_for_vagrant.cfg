# Kickstart file automatically generated by anaconda.

# Install OS instead of upgrade
install

# Install from attached ISO
cdrom

# Text installation
text
skipx

# Set language
lang en_NZ.UTF-8

# Set keyboard
keyboard us

# Disable firstboot
firstboot --disabled

# Configure network using DHCP and disable IPv6
network --onboot yes --device eth0 --bootproto dhcp --noipv6

# Set default root password
rootpw  --iscrypted $6$AfcUH/7TqRsC9BJI$5v3kgDNXBYxGJwEjRlb/gneHALcmpHeSq37/IgxviTy4wExWLwHmxUadHnVrkknvFE0X9ZU4Qj.GA8WCSbRMe0

# Allow SSH access via the firewall 
firewall --service=ssh

# Use stronger passwords
authconfig --enableshadow --passalgo=sha512

# Enable SELINUX
selinux --enforcing

# Set timezone
timezone --utc Pacific/Auckland

# Boot config
bootloader --location=mbr --driveorder=sda --append="nomodeset crashkernel=auto rhgb quiet --ipv6=off"

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
clearpart --all

# Clear MBR
zerombr

# Make a 500MB boot partition
part /boot --fstype=ext4 --size=500

# Make physical volume
part pv.008002 --grow --size=1

# Make Volume group 
volgroup vg_centos6 --pesize=4096 pv.008002

# Make (thin provisioned) logical volume
logvol / --fstype=ext4 --name=lv_root --vgname=vg_centos6 --grow --size=1024 --maxsize=51200
logvol swap --name=lv_swap --vgname=vg_centos6 --grow --size=2016 --maxsize=2016

# Create user for vagrant to login
user --name=vagrant --groups=wheel --password=vagrant

%packages --nobase
@core
wget-*el6.x86_64
perl-5.*el6*x86_64
sudo
-ppp*
-wpa_supplicant*
-btrfs-progs*
-bind*
-iw*firmware*
-ivtv*firmware*
-gsettings-desktop-schemas-*
%end

%post

# Backup all the original config from /etc
mkdir /backups 
tar czvf etc-$(date "+%F")-orig.tar.gz /etc >> /backups/backup.log

# Remove root password
passwd -d root


# Enabling sudo-less access for vagrant user
echo "vagrant        ALL=(ALL)       NOPASSWD: ALL"  >> /etc/sudoers.d/vagrant
echo "Defaults:vagrant !requiretty"                  >> /etc/sudoers.d/vagrant
echo "Defaults:%wheel env_keep += \"SSH_AUTH_SOCK\"" >> /etc/sudoers.d/vagrant
chmod 0440 /etc/sudoers.d/vagrant

# Disable Avahi
echo "Disabling Avahi"
systemctl disable avahi-daemon.service

# Disable kdump
echo "Disabling kdump"
systemctl disable kdump.service


/bin/mkdir -p /home/vagrant/.ssh
/bin/chmod 700 /home/vagrant/.ssh
/usr/bin/curl -L -o /home/vagrant/.ssh/id_rsa https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant
/usr/bin/curl -L -o /home/vagrant/.ssh/authorized_keys https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub
/bin/chown -R vagrant:vagrant /home/vagrant/.ssh
/bin/chmod 0400 /home/vagrant/.ssh/*
/bin/echo 'UseDNS no' >> /etc/ssh/sshd_config

/usr/bin/yum -y clean all

/bin/dd if=/dev/zero of=/boot/EMPTY bs=1M
/bin/rm -f /boot/EMPTY
/bin/dd if=/dev/zero of=/EMPTY bs=1M
/bin/rm -f /EMPTY

%end